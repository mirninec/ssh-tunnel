# SSH Tunnel Daemon

Этот скрипт реализует простой демон для создания и поддержания постоянного SSH-туннеля на Ubuntu. Он проверяет состояние туннеля и восстанавливает его в случае разрыва.

---

## Требования

-   Установленный SSH-клиент (`openssh-client`).
-   Без пароля доступ к удаленному серверу по SSH.
-   Права администратора (sudo) для настройки systemd.

## Установка и использование

### 1. Скачайте скрипт

```sh
wget https://github.com/mirninec/ssh-tunnel/ssh-tunnel.sh
```

Предоставить права на выполнение скрипта:

```sh
chmod +x ssh-tunnel.sh
```

Перенесите скрипт в системную директорию (например, /usr/local/bin):

```sh
sudo mv ssh-tunnel.sh /usr/local/bin/
```

Настройте параметры в скрипте (если необходимо, измените SSH_PORT, LOCAL_PORT, REMOTE_USER, REMOTE_HOST и LOG_FILE в начале скрипта).

### 2. Интеграция с systemd

Чтобы запускать скрипт как демон с помощью systemd, выполните следующие шаги:

Создайте unit-файл для systemd. Для этого создайте файл /etc/systemd/system/ssh-tunnel.service с следующим содержимым:

```ini
[Unit]
Description=SSH Tunnel Daemon
After=network.target

[Service]
ExecStart=/usr/local/bin/ssh-tunnel.sh
Restart=always
RestartSec=60
User=root  # или другой пользователь с правами на SSH

[Install]
WantedBy=multi-user.target
```

Перезагрузите systemd для применения изменений

```sh
sudo systemctl daemon-reload
```

Включите и запустите службу

```sh
sudo systemctl enable ssh-tunnel.service
sudo systemctl start ssh-tunnel.service
```

Проверьте статус службы

```sh
sudo systemctl status ssh-tunnel.service
```

### Просмотр логов

Логи systemd:

```sh
sudo journalctl -u ssh-tunnel.service -f
```

Логи скрипта:

```sh
sudo tail -f /var/log/ssh-tunnel.log
```

### Краткое описание скрипта

-   **SSH_PORT**: Порт, на котором работает SSH-сервер. Это переменная, которую пользователь может изменить в начале скрипта.
-   **LOCAL_PORT**: Локальный порт для SOCKS-прокси. Также изменяется в скрипте.
-   **EMOTE_USER**: Имя пользователя на удаленном сервере.
-   **REMOTE_HOST**: Адрес удаленного сервера.
-   **LOG_FILE**: Путь к файлу логов.

Скрипт работает в бесконечном цикле, проверяя каждые 60 секунд, активен ли SSH-туннель, и в случае его отсутствия восстанавливает его.

### Важно

Убедитесь, что у пользователя, под которым запускается скрипт, есть права на выполнение SSH без пароля, или предусмотрите ввод пароля в скрипте.
Скрипт предназначен для работы на системах на базе Linux, с предварительно настроенным SSH доступом к удаленному серверу.

### Пример настройки доступа к удаленному серверу по SSH без пароля

1. Проверьте наличие существующих ключей:

```sh
ls ~/.ssh
```

2. Если ключей нет, сгенерируйте SSH-пару (публичный и приватный ключи):

```sh
cd ~/.ssh/
ssh-keygen
```

3. Скопируйте публичный ключ на удаленный сервер:

```sh
ssh-copy-id -i ~/.ssh/id_rsa.pub $REMOTE_USER@$REMOTE_HOST
```

4. Проверьте подключение:

```sh
ssh -p $SSH_PORT $REMOTE_USER@$REMOTE_HOST
```

### Пример использования

После запуска SSH-туннеля вы можете использовать SOCKS-прокси на локальном порту $LOCAL_PORT. Например, в браузере Firefox:

<ol>
<li>   Откройте настройки сети. </li>
<li>   Выберите "Ручная настройка прокси".</li>
<li>   Укажите localhost в поле "SOCKS-хост" и $LOCAL_PORT в поле "Порт". </li>
<li>   Сохраните настройки.</li>
</ol>

Для использования в командной строке, например, с _curl_ или _wget_:

```sh
curl --socks5 localhost:$LOCAL_PORT example.com
```

```sh
wget --proxy-user= --proxy-password= --socks5-hostname=localhost:$LOCAL_PORT example.com
```

### Возможные проблемы

**SSH-ключ не распознается:** Убедитесь, что вы скопировали правильный публичный ключ на сервер и что права на файл .ssh/authorized_keys на сервере установлены правильно.

**Туннель не восстанавливается:** Проверьте логи скрипта и systemd для выявления ошибок. Возможно, нужны дополнительные права или настройки в скрипте.

### Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле [LICENSE](LICENSE).
